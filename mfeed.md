### StackStormはデータセンターのダクトテープ！？

StackStorm創立メンバーの[Dmitri](https://stackstorm.com/team/)がStackStormの紹介をする際、よくそのプレゼンテーションで、StackStormを上記のように例えています。これは、StackStormがもたらす自動化が、何か全く新しい仕組みでもって実現される物、ではなく、既存のシステムやソフトウェアを十分に活かし、それらを **つなぎ合わせて** 結果的に自動化を達成するというものであるという側面を表すのにピッタリの言葉だと思います。

弊社インターネットマルチフィード(以下、MF)においても、StackStormは社内に存在する複数のシステムを「つなぎ合わせて」自動化を達成する、という点で非常に大きな役割を果たしました。弊社の取り組みの中で、StackStormを導入するに至った経緯と、その効果を以下に紹介します。

(本記事と併せて、[StackStorm勉強会 第2回のスライド](https://www.slideshare.net/shusugimoto1986/ixstackstorm)・動画をご覧いただくと、より分かりやすいと思います。)

### JPNAPでの自動化のはじまり、そして直面した課題

弊社はアジア最大級のIX(インターネットエクスチェンジ)である「JPNAP」を運用しています。IXは、とても簡略化して言うと巨大なL2スイッチで、お客様にはそのポートをご提供し、そこに接続している他のお客様とトラフィックを交換出来るようにするネットワークサービスです。弊社では、年々増え続けるお客様からの新規のお申込みや、既存の1Gから10G、10Gから100Gへのアップグレードなどに対応するべく、このポート開通作業(いわゆるSO: Service Order)を自動化する取り組みを進めてきました。

取り組みは自体は2014年頃から始まり、それまでテキストファイルやExcel管理だったものをDB化したり、人が手順書を元に手作業で実施していたネットワーク機器への設定操作をツール化したりと、業務の様々な箇所で次々とシステム化が進みました。この時、それぞれのシステム・ツールは意図的に独立して開発が行われました。JPNAPは運用中のサービスであるため、新しい物を導入する際にはスムーズに行えるよう、日々の業務に対する影響は最小限になるようにした結果です。また各システムの導入を早め、それぞれのシステムでの成果を早く出したかったというのもあります。

しかしある時、「各々の *パーツ* は揃ってきたが、これをどのようにして連携させればいいのだろうか？」という課題に直面しました。



つまり、複数のシステムが関係し、それぞれに適切な処理を行う必要のある「業務フロー」について、これを自動化をするためには、次の課題を解決する必要が出てきたのです。

- 複数のシステムを横断的に処理する仕組みをどうやって実装すればよいか？
- あるシステムでは処理を行う際に排他的に実施したい、つまり同時実行制御を行いたいが、これを複数のシステムが横断する処理の中でどう実現すればよいか？

特に後者は、具体的に言うとネットワーク機器に対してコンフィグ投入を行うツールの部分になります。利用しているネットワーク機器の方で排他制御が出来ない場合、ツール側でこれを担保する必要があります。

ここにピタッと当てはまったのが、StackStormでした。

### StackStormがもたらしたもの

#### システム連携を実現する「ダクトテープ」的な役割

StackStormを導入したことによって得られたものとして挙げられるのは、まず、そのものずばりですが、複数のシステムを横断した業務フローの実現です。弊社のケースでは、業務フローは複数のシステムに対する個別の処理の組み合わせによってなるものですが、これをStackStormの **Workflow** を使って実装しました。各システムに対する個別の処理は **Action** で実装しています。Actionを組み合わせてWorkflowで繋ぎ合わせているところが、まさにダクトテープを使って各システムを繋ぎ合わせているようです。

このようにして、それまで独立に実装し導入されていたパーツ同士をStackStormを使って **つなぎ合わせる** ことで、例えばデータを設備管理システムに登録すると、その通り機器を設定まで実施する、といった、業務フローの自動化を実現することが出来ました。

#### 高い再利用性

WorkflowもActionも、StackStormではYAMLファイルで定義し、それらを[Pack](https://docs.stackstorm.com/packs.html)(AWS, Docker, Sensu などのサードパーティのシステムごとの監視・制御する機能をまとめたモノ)単位でまとめて管理します。ここで、社内の各システムに対応するPackをつくってActionをまとめておくと、そのシステムを使う他の業務フローも定義しやすくなります。

#### キューイングと排他制御の実現

TODO

#### 開発を行う上でのメリット

これまで述べたとおり、StackStormを導入することで、それまで足りていなかったピースを埋め、課題を解決することが出来ました。それだけでも十分なのですが、実はStackStormを採用したことで、自動化の取り組みにおける開発において非常に大きな効果がありました。

##### ワークフローの実装方法の統一

ワークフローを、例えばある特定のシステムの中に実装してしまうと、その実装方法はそのシステム自体の実装に依存してしまいます。例えば、仮にRubyで書かれているシステムがあるとして、そのシステムからスタートする業務フローがあるとします。単純にそこで業務フローをシステムの一部として実装してしまうと、その業務フローはRubyで実装されることになります。いっぽう別のシステムがPythonで書かれている・・・となると、そこで実装される業務フローはPythonで書くことなり、業務フローの実装があっちとこっちで言語からして違う、という状況になってしまいます。アーキテクチャを考える上で、これは当然避けたいことでした。ここでStackStormを用いると、(もちろんStackStormに依存することにはなってしまいますが、)

- あらゆる業務フローに対応するWorkflowを、定められた共通の形式で記述出来る
- そして、その表現形式をYAMLに統一することが出来る

ということから大きなメリットを得ることが出来ます。

##### アーキテクチャの見通しが良くなる

システム間の連携をStackStormが全て担う、と定めた時から、アーキテクチャの全体的な見通しが良くなりました。システムが他のシステムを呼び出す、ということはつまりシステム間に依存関係を作ることになります。それが、StackStormのワークフローを複数のシステムに跨る唯一のポイントとする、というルールを定めることで、呼び出し元が常に一定になります。これには様々なメリットがありますが、その一つとして例えば呼び出し先のシステムの変更を行う際に、それが影響する他のシステムを容易に調べることが出来る、等が挙げられます。

また、あらゆる業務フローについて、そのワークフロー設計を容易に出来るようになりました。ワークフローは特定のシステムに依存しないので、本来は自由に考えることが出来ます。当然といえば当然のことですが、しかし、いざ実際にワークフローを考えるとなった時、既存のシステムがあると、それをベースに考えてしまいがちになり、無意識のうちに何らかの制約条件を考えていたりということがあります。しかし、StackStormのおかげで、それら既存システムの言ってみれば呪縛から独立したワークフローを純粋に業務フローから考え出すことが出来るようになり、このワークフローから逆算して各システムに必要なActionを見つけ出す事ができるようになりました。ここで洗い出しているのは、まさにそのシステムが持つ外部に公開すべきAPIになります。

ワークフローの開始点をStackStormに統一できた、というのもアーキテクチャの見通しを良くすることに大きく寄与しています。今のところこの呼び出しはStackStormのWebhookからのみ行っていますが、これを別の「IF」に置き換えて、例えば特定のログが流れてきたらこのワークフローを実行する、ということも将来的には簡単に出来るようになっています。

##### ワークフローのコードレビューやCI/CDが可能

StackStormではActionやWorkflowは全てYAMLで記述します。つまり、git等のSCMで変更管理が出来るという事になります。これによって、ソフトウェアのソースコードと同様に、業務のフローもYAMLによって変更の差分を表示出来るようになったり、プルリクエストを使ってレビューを行えるようになりました。また、従来のCIのソフトウェアと同じような仕組みでCI/CDが可能出会ったため、開発者にとってはとっつきやすく、他のアジャイルで開発しているシステムと同様に速い速度で開発を進めることが可能でした。


### さらなる自動化の促進へ

ここまで、StackStormの弊社での具体的な使用例と、それによって得られた効果を紹介しました。今後は、既に作ったPackを活用し更に自動化を進めていきたいと考えています。また、Auto Remediation = 障害が発生した際の自動復旧等も検討していこうと思います。

ちなみに余談ですが、Auto Remediationで使う場合等は特に、StackStorm自体のHAが課題になると思います。弊社ではStackStormの公式DockerイメージをKubernetesクラスタ上で動かすことを検証しており、これによってHAを実現しようと考えております。興味のある方は[StackStorm Docker Image のドキュメント](https://stackstorm.com/2017/04/21/official-stackstorm-docker-image-here/)をご覧ください。またStackStorm公式Slackの[#docker](https://stackstorm-community.slack.com/messages/C4QEPNE85/)チャネルでも質問等受け付けております。
